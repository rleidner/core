import{l as $,Q as j,_ as O,Z as V,Y as z,a4 as M,a5 as q,F as E}from"./vendor-fortawesome-82b7eff7.js";import{C as P}from"./index-9888bb36.js";import{C as B,p as F,a as N,L as K,b as Z,B as G,f as J,P as X,c as Y,T as U,i as Q,d as ee,e as te,g as ae}from"./vendor-chartjs-2bc02c38.js";import{_ as D,l as s,m as l,N as _,M as f,q as A,A as g,F as v,u as c,x as y,n as re,G as p,E as h,B as x,z as S}from"./vendor-cc4615be.js";import"./vendor-bootstrap-09a7ccd9.js";import"./vendor-jquery-13cad4c1.js";import"./vendor-axios-3dcaeec5.js";import"./vendor-sortablejs-7c09d6dd.js";import"./vendor-luxon-cc86f6dc.js";const ne={name:"LegendStandard",props:{items:{type:Array,default:()=>[]}},emits:["toggle"]},ie={class:"custom-legend d-flex flex-wrap justify-content-center"},oe=["onClick"],se={width:"20",height:"6",class:"mr-1"},le=["stroke","stroke-dasharray"];function de(e,t,r,o,n,a){return s(),l("div",ie,[(s(!0),l(_,null,f(r.items,i=>(s(),l("div",{key:i.label,class:A(["legend-item d-flex align-items-center m-1",{"legend-item-hidden":i.hidden}]),role:"button",onClick:d=>e.$emit("toggle",i.label)},[(s(),l("svg",se,[g("line",{x1:"0",y1:"3",x2:"20",y2:"3",stroke:i.borderColor,"stroke-width":"3","stroke-dasharray":i.borderDash&&i.borderDash.length?i.borderDash.join(","):""},null,8,le)])),g("span",{class:A(["legend-label",{"text-line-through":i.hidden}])},v(i.label),3)],10,oe))),128))])}const ce=D(ne,[["render",de],["__scopeId","data-v-40ecb731"],["__file","/opt/openWB-dev/openwb-ui-settings/src/components/chart/LegendStandard.vue"]]);const ue={name:"LegendCategory",props:{label:{type:String,default:""},items:{type:Array,default:()=>[]}},emits:["toggle"]},pe={class:"dropdown m-1"},he={class:"btn btn-secondary dropdown-toggle",type:"button","data-toggle":"dropdown","aria-expanded":"false"},ge={class:"dropdown-menu"},ye=["onClick"],me={width:"20",height:"6",class:"mr-1"},be=["stroke","stroke-dasharray"];function _e(e,t,r,o,n,a){return s(),l("div",pe,[g("button",he,v(r.label),1),g("ul",ge,[(s(!0),l(_,null,f(r.items,i=>(s(),l("li",{key:i.label,class:A(["dropdown-item",{"legend-item-hidden":i.hidden}]),onClick:d=>e.$emit("toggle",i.label)},[(s(),l("svg",me,[g("line",{x1:"0",y1:"3",x2:"20",y2:"3",stroke:i.borderColor,"stroke-width":"3","stroke-dasharray":i.borderDash&&i.borderDash.length?i.borderDash.join(","):""},null,8,be)])),g("span",{class:A({"text-line-through":i.hidden})},v(i.label),3)],10,ye))),128))])])}const fe=D(ue,[["render",_e],["__scopeId","data-v-1ce49a26"],["__file","/opt/openWB-dev/openwb-ui-settings/src/components/chart/LegendCategory.vue"]]),ke={name:"LegendCategoriesGroup",components:{LegendCategory:fe},props:{categorizedItems:{type:Object,default:()=>({chargepoint:[],vehicle:[],component:[]})}},emits:["toggle"],data(){return{categoryLabels:{component:"Komponenten",chargepoint:"Ladepunkte",vehicle:"Fahrzeuge"}}}},xe={class:"d-flex flex-wrap justify-content-center"};function ve(e,t,r,o,n,a){const i=c("LegendCategory");return s(),l("div",xe,[(s(!0),l(_,null,f(r.categorizedItems,(d,k)=>(s(),y(i,{key:k,label:n.categoryLabels[k],items:d,onToggle:t[0]||(t[0]=b=>e.$emit("toggle",b))},null,8,["label","items"]))),128))])}const De=D(ke,[["render",ve],["__file","/opt/openWB-dev/openwb-ui-settings/src/components/chart/LegendCategoriesGroup.vue"]]),Ce={name:"ChartLegend",components:{LegendCategoriesGroup:De,LegendStandard:ce},props:{chart:{type:Object,default:()=>null},range:{type:String,default:"day"}},computed:{legendItems(){if(!this.chart||!this.chart.data)return[];const e=this.$store.state.chartLegend.hiddenDatasets;return this.chart.data.datasets.map((t,r)=>({label:t.label,index:r,category:t.category||"component",hidden:e.includes(t.label),borderColor:t.borderColor,borderDash:t.borderDash}))},categorizedLegendItems(){var o,n;if(!this.chart)return{chargepoint:[],vehicle:[],component:[]};let e={};const t=this.$store.state.chartLegend.hiddenDatasets;return this.range==="day"?e={chargepoint:[],vehicle:[],component:[]}:e={chargepoint:[],component:[]},(((n=(o=this.chart)==null?void 0:o.data)==null?void 0:n.datasets)||[]).forEach((a,i)=>{const d=a.category||"component";e[d]||(e[d]=[]),e[d].push({label:a.label,index:i,hidden:t.includes(a.label),borderColor:a.borderColor,borderDash:a.borderDash})}),e},showStandardLegend(){return this.legendItems.length<12}},watch:{chart(e){this.defaultHiddenDatasets(e)}},mounted(){this.defaultHiddenDatasets(this.chart)},methods:{toggleDataset(e){if(!this.chart)return;const t=this.chart.data.datasets.find(r=>r.label===e);t&&(this.$store.commit("chartLegend/toggleDataset",t.label),this.applyHiddenDatasetsToChart())},defaultHiddenDatasets(e){if(e&&e.data&&e.data.datasets.length){const t=e.data.datasets.filter(r=>r.hidden).map(r=>r.label);this.$store.commit("chartLegend/setHiddenDatasets",t),this.applyHiddenDatasetsToChart()}},applyHiddenDatasetsToChart(){if(!this.chart||!this.chart.data)return;const e=this.$store.state.chartLegend.hiddenDatasets;this.chart.data.datasets.forEach(t=>{t.hidden=e.includes(t.label)}),this.chart.update()}}};function Ae(e,t,r,o,n,a){const i=c("LegendStandard"),d=c("LegendCategoriesGroup");return a.showStandardLegend?(s(),y(i,{key:r.range,items:a.legendItems,onToggle:a.toggleDataset},null,8,["items","onToggle"])):(s(),y(d,{key:1,"categorized-items":a.categorizedLegendItems,onToggle:a.toggleDataset},null,8,["categorized-items","onToggle"]))}const Se=D(Ce,[["render",Ae],["__file","/opt/openWB-dev/openwb-ui-settings/src/components/chart/ChartLegend.vue"]]);$.add(j,O,V,z,M,q);B.register(F,N,K,Z,G,J,X,Y,U,Q,ee);const we={name:"OpenwbChartView",components:{ChartjsLine:te,FontAwesomeIcon:E,ChartLegend:Se},mixins:[P],props:{initialChartRange:{type:String,required:!1,validator:function(e){return["day","month","year"].indexOf(e)!==-1},default:"day"},initialDate:{type:String,required:!1,validator:function(e){return e.match(/^(([0-9]{4})(-[0-9]{2}(-[0-9]{2})?)?)?$/g)},default:""}},emits:["sendCommand"],data(){return{chartInstance:null,mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/daily/#","openWB/log/monthly/#","openWB/log/yearly/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentDate:"",chartRange:"day",blockChartInit:!1,chartIsLoading:!1,chartRequestDate:{day:"",month:"",year:""},datasetTemplates:{"counter-power_average":{label:"Zähler",category:"component",unit:"kW",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energy_imported":{label:"Zähler",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energy_exported":{label:"Zähler",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(0, 255, 105, 0.7)",backgroundColor:"rgba(0, 255, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energy_imported_grid":{label:"Zähler (Netzanteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"#-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energy_imported_pv":{label:"Zähler (PV-Anteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(40, 167, 69, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"#-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energy_imported_bat":{label:"Zähler (PV-Anteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"#-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power_exported":{label:"PV",category:"component",unit:"kW",jsonKey:null,borderColor:"rgba(40, 167, 69, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y",stack:"inverter-power",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-energy_exported":{label:"PV",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(40, 167, 69, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y2",stack:"inverter-exported",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power_average":{label:"Speicher",category:"component",unit:"kW",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y",stack:"battery-power",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-energy_imported":{label:"Speicher",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y2",stack:"battery-imported",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-energy_exported":{label:"Speicher",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y2",stack:"battery-exported",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-soc":{label:"Speicher SoC",category:"component",unit:"%",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",borderWidth:2,data:null,yAxisID:"y3",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power_average":{label:"Ladepunkt",category:"chargepoint",unit:"kW",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y",stack:"charge-point-power",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energy_imported":{label:"Ladepunkt",category:"chargepoint",unit:"kWh",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y2",stack:"charge-point-imported",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energy_imported_grid":{label:"Ladepunkt (Netzanteil)",category:"chargepoint",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"charge-point-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energy_imported_pv":{label:"Ladepunkt (PV-Anteil)",category:"chargepoint",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(40, 167, 69, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"charge-point-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energy_imported_bat":{label:"Ladepunkt (PV-Anteil)",category:"chargepoint",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"charge-point-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"ev-soc":{label:"Fahrzeug SoC",category:"vehicle",unit:"%",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",borderWidth:2,data:null,yAxisID:"y3",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-power_average":{label:"SmartHome",category:"component",unit:"kW",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-energy_imported":{label:"SmartHome",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-energy_exported":{label:"SmartHome",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"hc-power_imported":{label:"Hausverbrauch",category:"component",unit:"kW",jsonKey:null,borderColor:"rgba(120, 122, 124, 0.7)",backgroundColor:"rgba(120, 122, 124, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"hc-energy_imported":{label:"Hausverbrauch",category:"component",unit:"kWh",jsonKey:null,borderColor:"rgba(120, 122, 124, 0.7)",backgroundColor:"rgba(120, 122, 124, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:1,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"hc-energy_imported_grid":{label:"Hausverbrauch (Netzanteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(120, 122, 124, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"hc-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"hc-energy_imported_pv":{label:"Hausverbrauch (PV-Anteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(40, 167, 69, 0.7)",backgroundColor:"rgba(120, 122, 124, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"hc-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"hc-energy_imported_bat":{label:"Hausverbrauch (PV-Anteil)",category:"component",unit:"kWh",type:"bar",jsonKey:null,borderColor:"rgba(253, 126, 20, 0.7)",backgroundColor:"rgba(120, 122, 124, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!0,borderWidth:3,data:null,yAxisID:"y2",stack:"hc-energy-imported-source",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0,callbacks:{label:e=>`${e.dataset.label}: ${e.formattedValue} ${e.dataset.unit}`}},legend:{display:!1},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:2}},responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{unit:"",tooltipFormat:""},display:!0,title:{display:!0,text:""},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:0},grid:{}},y:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Leistung [kW]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y2:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Energie [kWh]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y3:{position:"right",type:"linear",display:"auto",suggestedMin:0,suggestedMax:100,title:{font:{size:12},display:!0,text:"SoC [%]"},grid:{display:!1},ticks:{font:{size:12},stepSize:10,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{dateInput(){var e={title:"Datum",type:"date",min:"2018-01-01"};switch(this.chartRange){case"month":e={title:"Monat",type:"month",min:"2018-01"};break;case"year":e={title:"Jahr",type:"year",min:"2018"};break}return e},chartDate:{get(){var e=this.chartRequestDate.year;return this.chartRange!="year"&&(e=e+"-"+this.chartRequestDate.month),this.chartRange=="day"&&(e=e+"-"+this.chartRequestDate.day),e},set(e){let t=e.split("-");this.chartRequestDate.year=t[0],t.length>1?this.chartRequestDate.month=t[1]:this.chartRequestDate.month="",t.length>2?this.chartRequestDate.day=t[2]:this.chartRequestDate.day=""}},chartScaleX(){var e={unit:"minute",tooltipFormat:"DD T",text:"Zeit",maxTicksLimit:24};switch(this.chartRange){case"month":e={unit:"day",tooltipFormat:"DD",text:"Tag",maxTicksLimit:31};break;case"year":e={unit:"month",tooltipFormat:"LLLL yyyy",text:"Monat",maxTicksLimit:12};break}return e},commandData(){var e={date:this.chartRequestDate.year+this.chartRequestDate.month+this.chartRequestDate.day};switch(this.chartRange){case"month":e={date:this.chartRequestDate.year+this.chartRequestDate.month};break;case"year":e={date:this.chartRequestDate.year};break}return e},baseTopic(){var e="openWB/log/";switch(this.chartRange){case"day":e=e+"daily/";break;case"month":e=e+"monthly/";break;case"year":e=e+"yearly/";break}return e},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject?this.chartDataObject.length>0:!1},chartTotals(){if(this.$store.state.mqtt[this.baseTopic+this.commandData.date]&&Object.prototype.hasOwnProperty.call(this.$store.state.mqtt[this.baseTopic+this.commandData.date],"totals")){var e=JSON.parse(JSON.stringify(this.$store.state.mqtt[this.baseTopic+this.commandData.date].totals));return delete e.energy_source,Object.keys(e.counter).forEach(t=>{Object.prototype.hasOwnProperty.call(e.counter[t],"grid")&&delete e.counter[t].grid}),Object.keys(e).forEach(t=>{Object.prototype.hasOwnProperty.call(e[t],"all")&&(Object.keys(e[t]).length<=2&&["bat","pv"].includes(t)?delete e[t].all:e[t]={all:e[t].all,...e[t]})}),e}},chartDataObject(){if(this.$store.state.mqtt[this.baseTopic+this.commandData.date]){var e=this.$store.state.mqtt[this.baseTopic+this.commandData.date];Object.prototype.hasOwnProperty.call(e,"entries")&&(e=e.entries);let t={};return JSON.parse(JSON.stringify(e)).forEach(r=>{let o=r.timestamp*1e3-r.timestamp*1e3%36e5;if(this.chartRange==="day"){if(!t[o]){let n={...r,timestamp:o};t[o]=n}}else r.timestamp=r.timestamp*1e3,t[r.timestamp]=r}),Object.values(t)}},chartData(){if(this.chartDataObject){var e=["pv","counter","bat","cp","sh","ev","hc"];const t=this.chartDataObject[this.chartDataObject.length-1];return t&&e.forEach(r=>{Object.prototype.hasOwnProperty.call(t,r)&&(Object.prototype.hasOwnProperty.call(t[r],"all")&&(["bat","pv"].includes(r)&&Object.keys(t[r]).length<=2?delete t[r].all:t[r]={all:t[r].all,...t[r]}),Object.entries(t[r]).forEach(([o,n])=>{Object.keys(n).forEach(a=>{this.initDataset(r,o,a)})}))}),this.chartDatasets}}},watch:{chartRange(){this.init()},chartDataRead:{handler(e){e&&(this.chartIsLoading=!1)},immediate:!0}},updated(){this.$nextTick(()=>{var e;(e=this.$refs.myChart)!=null&&e.chart&&(this.chartInstance=this.$refs.myChart.chart)})},mounted(){this.init(),re(()=>{var e;this.chartInstance=(e=this.$refs.myChart)==null?void 0:e.chart})},methods:{getChartInstance(){return this.$refs.myChart?this.$refs.myChart.chart:null},refreshLegend(){this.$nextTick(()=>{var e;this.chartInstance=(e=this.$refs.myChart)==null?void 0:e.chart})},handleChartClick(e){if(this.chartRange=="day")return;const t=this.$refs.myChart.chart;if(!t)return;const r=ae(t,e);if(!r.length)return;const{datasetIndex:o,index:n}=r[0],a=this.chartData.datasets[o].data[n].date;var i="",d="";switch(this.chartRange){case"month":i=a.substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6),d="day";break;case"year":i=a.substring(0,4)+"-"+a.substring(4,6),d="month";break}this.blockChartInit=!0,this.chartDate=i,this.chartRange=d},getCardSubtype(e){switch(e){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";case"sh":return"pink";default:return"secondary"}},getCardIcon(e){switch(e){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];case"sh":return["fas","house-signal"];case"hc":return["fas","house"];default:return}},hideDataset(e,t,r){return!!(["bat","pv","cp"].includes(e)&&Object.prototype.hasOwnProperty.call(this.chartTotals[e],"all")&&t!="all"||["grid","bat","pv","cp"].includes(r.split("_").pop()))},getTotalsLabel(e,t=void 0,r=void 0){var o="*test*";if(!t&&!r){switch(e){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";case"sh":return"SmartHome-Geräte";case"hc":return"Hausverbrauch";default:console.warn("unknown group key:",e)}return"*"+e+"*"}if(t&&!r){if(t=="all")return"Summe";if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt[this.baseTopic+this.commandData.date],"names"))return this.$store.state.mqtt[this.baseTopic+this.commandData.date].names[t]}if(t&&r){switch(e){case"bat":case"cp":switch(r){case"imported":case"energy_imported":return"Ladung";case"exported":case"energy_exported":return"Entladung";case"energy_imported_grid":return"Ladung (Netz-Anteil)";case"energy_imported_pv":return"Ladung (PV-Anteil)";case"energy_imported_bat":return"Ladung (Speicher-Anteil)";case"energy_imported_cp":return"Ladung (Ladepunkt-Anteil)";default:console.warn("unknown measurement key:",e,r)}break;case"counter":switch(r){case"imported":case"energy_imported":return"Bezug/Verbrauch";case"exported":case"energy_exported":return"Einspeisung/Erzeugung";case"energy_imported_grid":return"Verbrauch (Netz-Anteil)";case"energy_imported_pv":return"Verbrauch (PV-Anteil)";case"energy_imported_bat":return"Verbrauch (Speicher-Anteil)";case"energy_imported_cp":return"Verbrauch (Ladepunkt-Anteil)";default:console.warn("unknown measurement key:",e,r)}break;case"pv":switch(r){case"exported":case"energy_exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,r)}break;case"sh":switch(r){case"imported":case"energy_imported":return"Verbrauch";case"exported":case"energy_exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,r)}break;case"hc":switch(r){case"imported":case"energy_imported":return"Verbrauch";case"energy_imported_grid":return"Verbrauch (Netz-Anteil)";case"energy_imported_pv":return"Verbrauch (PV-Anteil)";case"energy_imported_bat":return"Verbrauch (Speicher-Anteil)";case"energy_imported_cp":return"Verbrauch (Ladepunkt-Anteil)";default:console.warn("unknown measurement key:",e,r)}break;default:console.warn("unknown group key:",e)}return"*"+e+"+"+t+"+"+r+"*"}return o},getDatasetLabel(e,t,r,o){var n=["*"+o],a=[];if(t=="all")switch(e!=="hc"&&a.push("Summe"),e){case"pv":n=["PV"];break;case"bat":switch(n=["Speicher"],r){case"soc":n.push("SoC");break}break;case"cp":n=["Ladepunkte"];break;case"hc":n=["Hausverbrauch"]}else Object.prototype.hasOwnProperty.call(this.$store.state.mqtt[this.baseTopic+this.commandData.date],"names")&&Object.prototype.hasOwnProperty.call(this.$store.state.mqtt[this.baseTopic+this.commandData.date].names,t)&&(n=[this.$store.state.mqtt[this.baseTopic+this.commandData.date].names[t]]);switch(e){case"bat":case"ev":case"cp":switch(r){case"soc":a.push("SoC");break;case"energy_imported":a.push("Ladung");break;case"energy_exported":a.push("Entladung");break;case"energy_imported_grid":a.push("Netz-Anteil");break;case"energy_imported_pv":a.push("PV-Anteil");break;case"energy_imported_bat":a.push("Speicher-Anteil");break;case"energy_imported_cp":a.push("Ladepunkt-Anteil");break}break;case"counter":switch(r){case"energy_imported":a.push("Bezug/Verbrauch");break;case"energy_exported":a.push("Einspeisung/Erzeugung");break;case"energy_imported_grid":a.push("Netz-Anteil");break;case"energy_imported_pv":a.push("PV-Anteil");break;case"energy_imported_bat":a.push("Speicher-Anteil");break;case"energy_imported_cp":a.push("Ladepunkt-Anteil");break}break;case"sh":switch(r){case"energy_imported":a.push("Verbrauch");break;case"energy_exported":a.push("Erzeugung");break}break;case"hc":switch(r){case"energy_imported_grid":a.push("Netz-Anteil");break;case"energy_imported_pv":a.push("PV-Anteil");break;case"energy_imported_bat":a.push("Speicher-Anteil");break;case"energy_imported_cp":a.push("Ladepunkt-Anteil");break}break}return`${n.join(" ")}${a.length?" ("+a.join(", ")+")":""}`},getDatasetIndex(e){let t=this.chartDatasets.datasets.findIndex(r=>r.jsonKey==e);if(t!=-1)return t},updateDatasetStack(e,t,r){if(e){if(t=="all"&&!["grid","pv","bat","cp"].includes(r.split("_").slice(-1)[0])){console.debug("not stacking totals for:",e,t,r);return}return e.includes("#")?(console.debug("updating stack template:",e,t,r),e.replace("#",t)):e}},addDataset(e,t,r,o){if(console.debug("adding dataset:",e,t,r,o),!(Object.prototype.hasOwnProperty.call(this.chartTotals,e)&&!Object.prototype.hasOwnProperty.call(this.chartTotals[e],t))){var n=e+"-"+r;if(this.datasetTemplates[n]){var a=JSON.parse(JSON.stringify(this.datasetTemplates[n]));return a.parsing.yAxisKey=o,a.jsonKey=o,a.data=this.chartDataObject,a.category=this.datasetTemplates[n].category,a.label=this.getDatasetLabel(e,t,r,o),a.labelSuffix!=null&&(a.label=a.label+a.labelSuffix),a.hidden=this.hideDataset(e,t,r),a.stack=this.updateDatasetStack(a.stack,t,r),this.chartDatasets.datasets.push(a)-1}else console.warn("no matching template found for: "+o+" with template: "+n)}},initDataset(e,t,r){var o=[];this.chartRange=="day"?o={counter:["power_average"],pv:["power_exported"],bat:["power_average","soc"],cp:["power_average"],sh:["power_average"],ev:["soc"],hc:["power_imported"]}:o={counter:["energy_imported","energy_exported","energy_imported_grid","energy_imported_pv","energy_imported_bat"],pv:["energy_exported"],bat:["energy_imported","energy_exported"],cp:["energy_imported","energy_imported_grid","energy_imported_pv","energy_imported_bat"],sh:["energy_imported","energy_exported"],ev:[],hc:["energy_imported","energy_imported_grid","energy_imported_pv","energy_imported_bat"]};const n=e+"."+t+"."+r;if(o[e].includes(r)){var a=this.getDatasetIndex(n);a==null&&(a=this.addDataset(e,t,r,n))}else console.debug("skipping dataset:",n)},setupScaleX(){this.chartOptions.scales.x.time.unit=this.chartScaleX.unit,this.chartOptions.scales.x.time.tooltipFormat=this.chartScaleX.tooltipFormat,this.chartOptions.scales.x.title.text=this.chartScaleX.text,this.chartOptions.scales.x.ticks.maxTicksLimit=this.chartScaleX.maxTicksLimit},requestChart(){if(document.forms.chartFilterForm.reportValidity()){this.chartIsLoading=!0,this.setupScaleX(),this.chartDatasets.datasets=[];var t="";switch(this.chartRange){case"day":t="getDailyLog";break;case"month":t="getMonthlyLog";break;case"year":t="getYearlyLog";break}this.$emit("sendCommand",{command:t,data:this.commandData})}else{console.warn("form invalid");return}},clearChartData(){this.getWildcardIndexList(this.baseTopic+"+").forEach(e=>{this.$store.commit("removeTopic",`${this.baseTopic}${e}`)})},updateChart(){this.clearChartData(),this.requestChart()},init(){const e=new Date;this.currentDate=String(e.getFullYear()),this.chartRange!="year"&&(this.currentDate=this.currentDate+"-"+String(e.getMonth()+1).padStart(2,"0")),this.chartRange=="day"&&(this.currentDate=this.currentDate+"-"+String(e.getDate()).padStart(2,"0")),this.blockChartInit?this.blockChartInit=!1:this.initialDate==null||this.initialDate==""?this.chartDate=this.currentDate:this.chartDate=this.initialDate,this.updateChart()}}},Re={class:"chart"},Le={key:0},Ie={key:1},We={name:"chartFilterForm"},Te={key:1},He={key:1},$e={class:"openwb-chart"},je={name:"chartTotalsForm"},Oe={key:1};function Ve(e,t,r,o,n,a){const i=c("openwb-base-alert"),d=c("openwb-base-select-input"),k=c("openwb-base-text-input"),b=c("openwb-base-card"),R=c("chartjs-line"),L=c("ChartLegend"),I=c("font-awesome-icon"),W=c("openwb-base-heading");return s(),l("div",Re,[e.$store.state.mqtt["openWB/general/extern"]===!0?(s(),l("div",Le,[p(i,{subtype:"info"},{default:h(()=>t[3]||(t[3]=[x(' Die Auswertungen sind nicht verfügbar, solange sich diese openWB im Steuerungsmodus "secondary" befindet. Du findest alle Auswertungen in der openWB, welche sich im Steuerungsmodus "primary" befindet. ',-1)])),_:1,__:[3]})])):(s(),l("div",Ie,[p(b,{title:"Filter",collapsible:!0,collapsed:!1},{default:h(()=>[g("form",We,[p(d,{modelValue:n.chartRange,"onUpdate:modelValue":t[0]||(t[0]=m=>n.chartRange=m),title:"Zeitraum",options:[{value:"day",text:"Tag"},{value:"month",text:"Monat"},{value:"year",text:"Jahr"}]},null,8,["modelValue"]),p(k,{modelValue:a.chartDate,"onUpdate:modelValue":[t[1]||(t[1]=m=>a.chartDate=m),t[2]||(t[2]=m=>a.updateChart())],title:a.dateInput.title,subtype:a.dateInput.type,min:a.dateInput.min,max:n.currentDate,"show-quick-buttons":!0},null,8,["modelValue","title","subtype","min","max"])])]),_:1}),n.chartIsLoading?(s(),y(i,{key:0,subtype:"info"},{default:h(()=>t[4]||(t[4]=[x(" Daten werden geladen... ",-1)])),_:1,__:[4]})):(s(),l("div",Te,[a.chartDataHasEntries?(s(),l("div",He,[p(b,{title:"Diagramm",collapsible:!0,collapsed:!1,onExpanded:a.refreshLegend},{default:h(()=>[g("div",$e,[p(R,{ref:"myChart",data:a.chartData,options:n.chartOptions,onClick:a.handleChartClick},null,8,["data","options","onClick"])]),n.chartInstance?(s(),y(L,{key:n.chartDatasets.datasets.length,ref:"chartLegend",range:n.chartRange,chart:a.getChartInstance()},null,8,["range","chart"])):S("",!0)]),_:1},8,["onExpanded"]),p(b,{title:"Summen",collapsible:!0,collapsed:!0},{default:h(()=>[g("form",je,[(s(!0),l(_,null,f(Object.fromEntries(Object.entries(a.chartTotals).filter(([m,u])=>Object.keys(u).length>0)),(m,u)=>(s(),y(b,{key:u,collapsible:!0,collapsed:!0,subtype:a.getCardSubtype(u)},{header:h(()=>[p(I,{icon:a.getCardIcon(u)},null,8,["icon"]),x(" "+v(a.getTotalsLabel(u)),1)]),default:h(()=>[(s(!0),l(_,null,f(m,(T,C)=>(s(),l("div",{key:C},[u!=="hc"?(s(),y(W,{key:0},{default:h(()=>[x(v(a.getTotalsLabel(u,C)),1)]),_:2},1024)):S("",!0),(s(!0),l(_,null,f(T,(H,w)=>(s(),l("div",{key:w},[p(k,{title:a.getTotalsLabel(u,C,w),readonly:"",class:"text-right",unit:"kWh","model-value":e.formatNumber(H/1e3,3)},null,8,["title","model-value"])]))),128)),C=="all"&&u!="hc"?(s(),l("hr",Oe)):S("",!0)]))),128))]),_:2},1032,["subtype"]))),128))])]),_:1})])):(s(),y(i,{key:0,subtype:"info"},{default:h(()=>t[5]||(t[5]=[x(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ",-1)])),_:1,__:[5]}))]))]))])}const Ze=D(we,[["render",Ve],["__scopeId","data-v-e00a7cd5"],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/Chart.vue"]]);export{Ze as default};
